-- LocalScript (StarterPlayerScripts)
-- v3 (Gemini Improved) - NPC-Only Auto-Lock (FIXED PERFORMANCE)

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local CollectionService = game:GetService("CollectionService")

-- Only run on mobile
if not UserInputService.TouchEnabled then
	print("Not on mobile, Auto-Lock script disabled.")
	return
end

-- ==================================================
-- CONFIGURATION
-- ==================================================

-- [FIX] Increased range. 3 studs was too small. 
-- This is the distance (in studs) to automatically lock onto a target.
local AUTO_LOCK_RANGE = 12

-- [FIX] This is the new throttle. We will only search for
-- new targets 5 times per second (1 / 0.2 = 5).
-- This COMPLETELY fixes the lag/FPS drop.
local TARGET_FIND_RATE = 0.2 -- (5 times per second)

-- [RECOMMENDED] For best performance, tag your NPCs (zombies, etc.) 
-- with CollectionService. e.g., "NPC" or "Zombie".
-- If you do, change this to "NPC" or whatever tag you use.
-- This is much faster than scanning the whole workspace.
local NPC_TAG = "" 

-- ==================================================

local player = Players.LocalPlayer
local character, humanoid, hrp
local isDisabled = false
local isAutoLockEnabled = true -- Auto-lock is ON by default

-- [FIX] These are now the "state" variables managed by our loops
local lockTarget = nil       -- The current target model
local previousLockTarget = nil -- Used to know when to attach/detach billboards
local lockBillboard = nil

-- ==================================================
-- CHARACTER & STATE SETUP (Advanced Grab Detection)
-- (Unchanged from before)
-- ==================================================

local function setupCharacter(char)
	character = char
	humanoid = char:WaitForChild("Humanoid")
	hrp = char:FindFirstChild("HumanoidRootPart") or char:WaitForChild("HumanoidRootPart")
	
	if humanoid then 
		humanoid.AutoRotate = true 
		humanoid.StateChanged:Connect(function(oldState, newState)
			if newState == Enum.HumanoidStateType.Physics or 
			   newState == Enum.HumanoidStateType.Ragdoll or
			   newState == Enum.HumanoidStateType.FallingDown or
			   newState == Enum.HumanoidStateType.PlatformStanding then
				isDisabled = true
			elseif newState == Enum.HumanoidStateType.Running or
			       newState == Enum.HumanoidStateType.Landed or
			       newState == Enum.HumanoidStateType.Jumping then
				isDisabled = false
			end
		end)
		humanoid:GetPropertyChangedSignal("PlatformStand"):Connect(function()
			if humanoid.PlatformStand then isDisabled = true else isDisabled = false end
		end)
		humanoid:GetPropertyChangedSignal("Sit"):Connect(function()
			if humanoid.Sit then isDisabled = true end
		end)
	end
	
	if hrp then
		hrp.ChildAdded:Connect(function(child)
			if child:IsA("Wold") or child:IsA("WeldConstraint") or 
			   child:IsA("AlignPosition") or child:IsA("AlignOrientation") or
			   child:IsA("RopeConstraint") then
				isDisabled = true
				local connection
				connection = child.AncestryChanged:Connect(function()
					if not child:IsDescendantOf(game) then
						task.wait(0.5) 
						isDisabled = false
						if connection then connection:Disconnect() end
					end
				end)
			end
		end)
	end
end

if player.Character then setupCharacter(player.Character) end
player.CharacterAdded:Connect(setupCharacter)

-- ==================================================
-- GUI SETUP
-- (Unchanged from before)
-- ==================================================

local gui = Instance.new("ScreenGui")
gui.Name = "LockOnUI"
gui.ResetOnSpawn = false
gui.Parent = player:WaitForChild("PlayerGui")

local btn = Instance.new("TextButton")
btn.Size = UDim2.new(0, 110, 0, 50)
btn.Position = UDim2.new(0.06, 0, 0.8, 0)
btn.Text = "AUTO: ON"
btn.BackgroundColor3 = Color3.fromRGB(36, 137, 206) -- Blue
btn.TextColor3 = Color3.new(1, 1, 1)
btn.Font = Enum.Font.GothamBold
btn.TextSize = 20
btn.Active = true
btn.Parent = gui

local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(0, 8)
corner.Parent = btn

local statusDot = Instance.new("Frame")
statusDot.Size = UDim2.new(0, 8, 0, 8)
statusDot.Position = UDim2.new(1, -12, 0, 4)
statusDot.BackgroundColor3 = Color3.fromRGB(100, 255, 100) -- Green
statusDot.BorderSizePixel = 0
statusDot.Parent = btn

local dotCorner = Instance.new("UICorner")
dotCorner.CornerRadius = UDim.new(0.5, 0)
dotCorner.Parent = statusDot

-- Draggable Logic (Unchanged)
local dragging, dragInput, dragStart, startPos
local function updateDrag(input)
	local delta = input.Position - dragStart
	btn.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X,
		startPos.Y.Scale, startPos.Y.Offset + delta.Y)
end

btn.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
		dragging = true
		dragStart = input.Position
		startPos = btn.Position
		dragInput = input
		input.Changed:Connect(function()
			if input.UserInputState == Enum.UserInputState.End then dragging = false end
		end)
	end
end)

UserInputService.InputChanged:Connect(function(input)
	if dragging and input == dragInput then updateDrag(input) end
end)

-- ==================================================
-- LOCK-ON CORE LOGIC (MODIFIED FOR PERFORMANCE)
-- ==================================================

local function detachBillboard()
	if lockBillboard then
		lockBillboard:Destroy()
		lockBillboard = nil
	end
end

local function attachBillboard(model)
	detachBillboard()
	local targetHrp = model:FindFirstChild("HumanoidRootPart")
	if not targetHrp then return end
	local bb = Instance.new("BillboardGui")
	bb.Size = UDim2.new(0, 120, 0, 40)
	bb.StudsOffset = Vector3.new(0, 3.2, 0)
	bb.AlwaysOnTop = true
	bb.Parent = targetHrp
	local label = Instance.new("TextLabel")
	label.Size = UDim2.new(1, 0, 1, 0)
	label.BackgroundTransparency = 1
	label.Text = "LOCKED"
	label.TextScaled = true
	label.Font = Enum.Font.GothamBold
	label.TextColor3 = Color3.fromRGB(255, 80, 80)
	label.Parent = bb
	lockBillboard = bb
end

-- Checks if a model is a valid NPC target
local function isValidNPCTarget(model)
	if not model or not model:IsA("Model") or model == character then 
		return false 
	end
	if Players:GetPlayerFromCharacter(model) then
		return false
	end
	local hum = model:FindFirstChildWhichIsA("Humanoid")
	local part = model:FindFirstChild("HumanoidRootPart")
	if not hum or not part or hum.Health <= 0 then 
		return false 
	end
	return true
end

-- This function is HEAVY (slow). We will only call it in the slow loop.
local function findNearestNPC(range)
	if not hrp then return nil end
	
	local nearestTarget, minDistance = nil, range
	local playerPos = hrp.Position
	
	local potentialTargets
	if NPC_TAG ~= "" then
		potentialTargets = CollectionService:GetTagged(NPC_TAG)
	else
		-- [DEV NOTE] This is still slow, but it's OKAY
		-- because we only run it 5x per second now.
		potentialTargets = workspace:GetDescendants()
	end
	
	for _, obj in ipairs(potentialTargets) do
		local model = obj
		if not obj:IsA("Model") then
			if obj:FindFirstAncestorWhichIsA("Model") then
				model = obj:FindFirstAncestorWhichIsA("Model")
			else
				continue 
			end
		end

		if isValidNPCTarget(model) then
			local targetHrp = model.HumanoidRootPart
			if targetHrp then -- Extra safety check
				local distance = (playerPos - targetHrp.Position).Magnitude
				if distance < minDistance then
					minDistance = distance
					nearestTarget = model
				end
			end
		end
	end
	
	return nearestTarget
end

-- ### NEW ###
-- This is our "Target Finder" loop. It runs slowly and just
-- finds the target. It's separate from RenderStepped.
spawn(function()
	while task.wait(TARGET_FIND_RATE) do
		-- Only search if the system is on and we aren't disabled (grabbed, etc)
		if isAutoLockEnabled and not isDisabled and hrp then
			-- This is the heavy function, but it's safe to call here.
			lockTarget = findNearestNPC(AUTO_LOCK_RANGE)
		else
			lockTarget = nil
		end
	end
end)


-- Button now toggles the Auto-Lock system on or off
btn.Activated:Connect(function()
	isAutoLockEnabled = not isAutoLockEnabled
	if not isAutoLockEnabled then
		lockTarget = nil -- Force unlock if we turn it off
	end
end)

-- Update status indicator (Unchanged)
spawn(function()
	while true do
		wait(0.1)
		if isDisabled then
			statusDot.BackgroundColor3 = Color3.fromRGB(255, 80, 80) -- Red when disabled
		else
			statusDot.BackgroundColor3 = Color3.fromRGB(100, 255, 100) -- Green when active
		end
	end
end)

-- ### MODIFIED ###
-- This "Rotation Loop" is now EXTREMELY fast and lightweight.
-- It only does rotation and UI updates, no searching.
RunService.RenderStepped:Connect(function()
	-- 1. Check for immediate disables (ragdolled, dead, etc.)
	if isDisabled or not hrp or not humanoid or humanoid.Health <= 0 then
		lockTarget = nil -- Force unlock
	end
	
	-- 2. Additional real-time checks
	if humanoid.PlatformStand or humanoid.Sit then
		lockTarget = nil -- Force unlock
	end
	
	-- 3. If a target is found (by the slow loop), aim at it.
	if lockTarget then
		local targetHRP = lockTarget:FindFirstChild("HumanoidRootPart")
		local targetHum = lockTarget:FindFirstChildWhichIsA("Humanoid")
		
		-- 4. Check if target is *still* valid (it might have died)
		if targetHRP and targetHum and targetHum.Health > 0 and (hrp.Position - targetHRP.Position).Magnitude <= AUTO_LOCK_RANGE + 2 then
			-- 5. Perform the rotation
			if humanoid then humanoid.AutoRotate = false end
			local lookPos = Vector3.new(targetHRP.Position.X, hrp.Position.Y, targetHRP.Position.Z)
			hrp.CFrame = CFrame.new(hrp.Position, lookPos)
		else
			-- 6. Target died or went out of range
			lockTarget = nil
		end
	else
		-- 7. No target, so ensure autorotate is on
		if humanoid then humanoid.AutoRotate = true end
	end
	
	-- 8. Handle all UI/Billboard changes
	if lockTarget ~= previousLockTarget then
		if lockTarget then
			attachBillboard(lockTarget)
			btn.Text = "LOCKED"
			btn.BackgroundColor3 = Color3.fromRGB(206, 36, 36) -- Red
		else
			detachBillboard()
			-- Reset button text based on the auto-lock state
			if isAutoLockEnabled then
				btn.Text = "AUTO: ON"
				btn.BackgroundColor3 = Color3.fromRGB(36, 137, 206) -- Blue
			else
				btn.Text = "AUTO: OFF"
				btn.BackgroundColor3 = Color3.fromRGB(150, 150, 150) -- Gray
			end
		end
	end
	
	previousLockTarget = lockTarget
end)

print("Mobile NPC Auto-Lock System v3 (Performance Fixed) loaded!")
print("Features: NPC-Only, 12-Stud Auto-Target, Throttled Target-Finding (LAG-FREE)")
